<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WVSSM Registration ‚Äî Shaviyani Atoll HCFs</title>

  <!-- Required for PWA -->
  <link rel="manifest" href="https://shaviyani-immunization.github.io/wvssm/register/manifest.json" />
  <link rel="icon" href="https://shaviyani-immunization.github.io/wvssm/register/icons/icon-192.png" type="image/png" />

  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />

  <style>
    form {
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      line-height: 1.5;
      color: #333;
    }
    label {
      font-weight: 600;
    }
    input,
    select,
    textarea {
      font-family: inherit;
      font-size: 16px;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .is-hidden {
      display: none !important;
    }
    .loading-spinner svg {
      width: 50px;
      height: 50px;
      stroke: #007bff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .is-invalid {
      border-color: #dc3545 !important;
      background-color: #fff0f0;
    }
    /* Inline validation messages */
    .form-text.text-danger {
      font-weight: 600;
    }
    /* Hide elements for screen readers */
    .visually-hidden {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0,0,0,0) !important;
      border: 0 !important;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8 col-sm-12">
        <div class="card shadow-sm">
          <div class="card-body">

<div class="d-flex justify-content-center align-items-center mb-4 gap-2 flex-wrap">
  <div>
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <circle cx="12" cy="7" r="4" />
      <path d="M5.5 21a6.5 6.5 0 0 1 13 0" />
    </svg>
  </div>
  <div class="text-center">
    <h5 class="mb-1">
      WVSSM <small>(Web-based Vaccination Supplies Stock Management)</small> Registration
    </h5>
    <h6 class="mb-2 text-secondary">Shaviyani Atoll Health Facilities</h6>
  </div>
</div>


            <!-- Offline alert -->
            <div id="offlineAlert" class="alert alert-warning text-center visually-hidden" role="alert" aria-live="assertive" aria-atomic="true">
              ‚ö†Ô∏è You are currently offline. Form submission will fail until you reconnect.
            </div>

            <form
              name="submit-to-google-sheet"
              id="registrationForm"
              action="https://script.google.com/macros/s/AKfycbxbix37d58ZWLXcaFDyANi2jmMFTYdtypDWhXh6yQY1UwqHizIKbkTPqjcSvFP4C6oy/exec"
              method="POST"
              novalidate
            >
              <div class="mb-3">
                <label for="recipientLabel" class="form-label">Health Facility / Department</label>
                <select id="recipientLabel" name="recipientLabel" autocomplete="off" required>
                  <option value="" disabled selected hidden>Select Health Facility or Department</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="idNumber" class="form-label">ID Number</label>
                <input
                  type="text"
                  class="form-control"
                  id="idNumber"
                  name="idNumber"
                  required
                  autocomplete="off"
                  aria-describedby="idNumberHelp"
                  aria-invalid="false"
                  maxlength="7"
                />
                <div id="idNumberHelp" class="form-text text-danger visually-hidden"></div>
              </div>

              <div class="mb-3">
                <label for="confirmIdNumber" class="form-label">Confirm ID Number</label>
                <input
                  type="text"
                  class="form-control"
                  id="confirmIdNumber"
                  required
                  autocomplete="off"
                  onpaste="return false;"
                  aria-describedby="confirmIdHelp"
                  aria-invalid="false"
                  maxlength="7"
                />
                <div id="confirmIdHelp" class="form-text text-danger visually-hidden"></div>
              </div>

              <div class="mb-3">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" name="firstName" required />
              </div>

              <div class="mb-3">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" name="lastName" required />
              </div>

              <div class="mb-3">
                <label for="jobTitle" class="form-label">Job Title</label>
                <select id="jobTitle" name="jobTitle" autocomplete="off" required>
                  <option value="" disabled selected hidden>Select or type a job title...</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone" name="phone" required autocomplete="off" />
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                  aria-describedby="emailHelp"
                  aria-invalid="false"
                />
              </div>

              <div class="mb-3">
                <label for="confirmEmail" class="form-label">Confirm Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="confirmEmail"
                  required
                  onpaste="return false;"
                  aria-describedby="confirmEmailHelp"
                  aria-invalid="false"
                />
                <div id="confirmEmailHelp" class="form-text text-danger visually-hidden"></div>
              </div>

              <button type="submit" class="btn btn-primary w-100" id="submitBtn" disabled>Submit</button>
            </form>

            <div class="loading js-loading is-hidden text-center my-3" aria-live="polite" aria-busy="true">
              <div class="loading-spinner" role="img" aria-label="Loading spinner">
                <svg><circle cx="25" cy="25" r="20" fill="none" stroke-width="4" stroke-miterlimit="10" /></svg>
              </div>
            </div>

            <p class="js-success-message text-success text-center is-hidden" role="alert" aria-live="assertive">‚úÖ Form submitted successfully!</p>
            <p class="js-error-message text-danger text-center is-hidden" role="alert" aria-live="assertive">‚ùå Submission failed. Please try again.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

  <!-- Job Title and Recipient Fetch & TomSelect Initialization -->
  <script>
    let jobTitleSelect, recipientLabelSelect;

    fetch('https://script.google.com/macros/s/AKfycbxbix37d58ZWLXcaFDyANi2jmMFTYdtypDWhXh6yQY1UwqHizIKbkTPqjcSvFP4C6oy/exec')
      .then((res) => res.json())
      .then((data) => {
        const jobTitles = (data.jobTitles || []).filter((title) => title.trim() !== '');
        const recipientLabels = (data.recipientLabels || []).filter((label) => label.trim() !== '');

        jobTitleSelect = new TomSelect('#jobTitle', {
          options: jobTitles.map((title) => ({ value: title, text: title })),
          create: (input) => {
            const trimmed = input.trim();
            return trimmed ? { value: trimmed, text: trimmed } : false;
          },
          sortField: { field: 'text', direction: 'asc' },
        });

        recipientLabelSelect = new TomSelect('#recipientLabel', {
          options: recipientLabels.map((label) => ({ value: label, text: label })),
          create: false,
          sortField: [], // disables default sorting
        });
      })
      .catch(() => {
        jobTitleSelect = new TomSelect('#jobTitle', { create: true });
        recipientLabelSelect = new TomSelect('#recipientLabel', { create: false, sortField: [] });
      });
  </script>

  <!-- Validation and Input Restrictions -->
  <script>
    const idInput = document.getElementById('idNumber');
    const confirmIdInput = document.getElementById('confirmIdNumber');
    const emailInput = document.getElementById('email');
    const confirmEmailInput = document.getElementById('confirmEmail');
    const submitBtn = document.getElementById('submitBtn');

    const idHelp = document.getElementById('idNumberHelp');
    const confirmIdHelp = document.getElementById('confirmIdHelp');
    const confirmEmailHelp = document.getElementById('confirmEmailHelp');

    const idPattern = /^A\d{6}$/;

    function formatAndValidate() {
      // Auto-capitalize first character in ID fields
      [idInput, confirmIdInput].forEach((input) => {
        if (input.value.length > 0) {
          input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1);
        }
      });

      const idValid = idPattern.test(idInput.value);
      const idMatch = idInput.value === confirmIdInput.value && idValid;
      const emailMatch = emailInput.value === confirmEmailInput.value;

      // Toggle input invalid styling
      idInput.classList.toggle('is-invalid', !idValid);
      confirmIdInput.classList.toggle('is-invalid', !idMatch);
      confirmEmailInput.classList.toggle('is-invalid', !emailMatch);

      // Toggle aria-invalid attributes for accessibility
      idInput.setAttribute('aria-invalid', (!idValid).toString());
      confirmIdInput.setAttribute('aria-invalid', (!idMatch).toString());
      confirmEmailInput.setAttribute('aria-invalid', (!emailMatch).toString());

      // Inline validation messages
      if (!idValid) {
        idHelp.textContent = "ID Number must start with 'A' followed by exactly 6 digits.";
        idHelp.classList.remove('visually-hidden');
      } else {
        idHelp.textContent = '';
        idHelp.classList.add('visually-hidden');
      }

      if (!idMatch) {
        confirmIdHelp.textContent = 'ID Number and Confirm ID Number do not match.';
        confirmIdHelp.classList.remove('visually-hidden');
      } else {
        confirmIdHelp.textContent = '';
        confirmIdHelp.classList.add('visually-hidden');
      }

      if (!emailMatch) {
        confirmEmailHelp.textContent = 'Email and Confirm Email do not match.';
        confirmEmailHelp.classList.remove('visually-hidden');
      } else {
        confirmEmailHelp.textContent = '';
        confirmEmailHelp.classList.add('visually-hidden');
      }

      // Enable submit only if all valid
      submitBtn.disabled = !(idMatch && emailMatch && idValid);
    }

    // Fix: Allow navigation keys so backspace/delete work on id input
    function restrictIdInput(event) {
      const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
      if (allowedKeys.includes(event.key)) {
        return; // allow editing/navigation keys
      }

      const value = event.target.value;
      const key = event.key;

      if (value.length === 0) {
        // First char must be 'A' or 'a'
        if (!['A', 'a'].includes(key)) {
          event.preventDefault();
        }
      } else if (value.length > 0 && value.length < 7) {
        // Next chars must be digits 0-9
        if (!/^\d$/.test(key)) {
          event.preventDefault();
        }
      } else {
        // No more input allowed if length >= 7
        event.preventDefault();
      }
    }

    // Sanitize pasted text for ID inputs
    function sanitizeOnPaste(event) {
      let paste = (event.clipboardData || window.clipboardData).getData('text');
      paste = paste.toUpperCase().replace(/[^A0-9]/g, '');
      if (!/^A\d{0,6}$/.test(paste)) {
        event.preventDefault();
      }
    }

    [idInput, confirmIdInput].forEach((input) => {
      input.addEventListener('keydown', restrictIdInput);
      input.addEventListener('paste', sanitizeOnPaste);
      input.addEventListener('input', formatAndValidate);
    });

    [emailInput, confirmEmailInput].forEach((input) => {
      input.addEventListener('input', formatAndValidate);
    });

    // Initial validation on page load
    window.addEventListener('load', formatAndValidate);
  </script>

  <!-- Form Submission -->
  <script>
    const scriptURL =
      'https://script.google.com/macros/s/AKfycbxbix37d58ZWLXcaFDyANi2jmMFTYdtypDWhXh6yQY1UwqHizIKbkTPqjcSvFP4C6oy/exec';
    const form = document.forms['submit-to-google-sheet'];
    const loading = document.querySelector('.js-loading');
    const successMessage = document.querySelector('.js-success-message');
    const errorMessage = document.querySelector('.js-error-message');

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      // Prevent submission if offline or button disabled
      if (!navigator.onLine || submitBtn.disabled) return;

      form.classList.add('is-hidden');
      loading.classList.remove('is-hidden');

      fetch(scriptURL, {
        method: 'POST',
        body: new FormData(form),
      })
        .then(() => {
          loading.classList.add('is-hidden');
          successMessage.classList.remove('is-hidden');

          form.reset();

          // Clear Tom Select selections
          if (jobTitleSelect) jobTitleSelect.clear();
          if (recipientLabelSelect) recipientLabelSelect.clear();

          // Remove invalid classes and messages
          [idInput, confirmIdInput, emailInput, confirmEmailInput].forEach((input) => {
            input.classList.remove('is-invalid');
            input.setAttribute('aria-invalid', 'false');
          });

          [idHelp, confirmIdHelp, confirmEmailHelp].forEach((el) => {
            el.textContent = '';
            el.classList.add('visually-hidden');
          });

          submitBtn.disabled = true;

          setTimeout(() => {
            form.classList.remove('is-hidden');
            successMessage.classList.add('is-hidden');
          }, 3000);
        })
        .catch(() => {
          loading.classList.add('is-hidden');
          errorMessage.classList.remove('is-hidden');

          setTimeout(() => {
            form.classList.remove('is-hidden');
            errorMessage.classList.add('is-hidden');
          }, 3000);
        });
    });
  </script>

  <!-- Offline Alert & Submit Button Disable -->
  <script>
    const offlineAlert = document.getElementById('offlineAlert');

    function updateOnlineStatus() {
      if (navigator.onLine) {
        offlineAlert.classList.add('visually-hidden');
        formatAndValidate(); // re-check validation to enable/disable submit
      } else {
        offlineAlert.classList.remove('visually-hidden');
        submitBtn.disabled = true;
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  </script>

  <!-- iOS Install Prompt (Only on iPhone/iPad) -->
<div
  id="iosInstallPrompt"
  class="alert alert-info text-center mb-0 py-2"
  role="alert"
  style="display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; background: #e3f2fd; border: none; border-top: 2px solid #2196f3;"
>
  <p class="mb-1">
    <strong>Install WVSSM Registration</strong><br />
    Tap the <strong>üì§ Share</strong> icon, then <strong>"Add to Home Screen"</strong>
  </p>
  <button type="button" class="btn btn-sm btn-outline-primary" onclick="dismissIosPrompt()">Maybe Later</button>
</div>

<!-- Android/Desktop Install Button -->
<button
  id="installBtn"
  class="btn btn-success"
  style="display: none; position: fixed; right: 20px; bottom: 20px; z-index: 9999; padding: 12px 18px; border-radius: 50px; font-weight: 600;"
>
  Install WVSSM Registration
</button>

<!-- ARIA Live Region for Accessibility -->
<div aria-live="polite" style="position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(1px,1px,1px,1px);">
  <span id="installStatus" role="status"></span>
</div>

<script>
  // --- iOS Logic ---
  function isIosDevice() {
    return /iphone|ipad|ipod/i.test(navigator.userAgent);
  }

  function isInStandaloneMode() {
    return ('standalone' in window.navigator) && window.navigator.standalone;
  }

  function dismissIosPrompt() {
    document.getElementById('iosInstallPrompt').style.display = 'none';
    localStorage.setItem('iosPromptDismissed', 'true');
  }

  window.addEventListener('load', () => {
    if (isIosDevice() && !isInStandaloneMode() && !localStorage.getItem('iosPromptDismissed')) {
      document.getElementById('iosInstallPrompt').style.display = 'block';
    }
  });

  // --- Android / Desktop PWA Install ---
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');
  const installStatus = document.getElementById('installStatus');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;

    if (outcome === 'accepted') {
      installBtn.style.display = 'none';
      installStatus.textContent = 'WVSSM Registration app was installed';
    } else {
      installStatus.textContent = 'WVSSM Registration installation was dismissed';
    }

    deferredPrompt = null;
  });
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./register/service-worker.js', { scope: '/wvssm/' })
      .then(reg => console.log('Service Worker registered:', reg.scope))
      .catch(err => console.error('Service Worker registration failed:', err));
  }
</script>

</body>
</html>
